name: Rust

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
     - cron: "15 4 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  collect-data:
    runs-on: ubuntu-latest

    steps:
    - name: Report rust version
      run: |
        rustc -vV
        rustup update
        rustc -vV

    - uses: actions/checkout@v5

    - name: Download binary
      run: |
          set -x
          curl -s -H "Accept: application/vnd.github+json" "https://api.github.com/repos/szabgab/pydigger.rs/actions/artifacts" > artifacts.json
          cat artifacts.json
          ARTIFACT_ID=$(jq '.artifacts[0].id' artifacts.json)
          echo "ARTIFACT_ID=$ARTIFACT_ID" >> $GITHUB_ENV
          curl -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/szabgab/pydigger.rs/actions/artifacts/$ARTIFACT_ID/zip" -o artifact.zip
          tree
          unzip artifact.zip
          tree


    - name: List
      run: |
        chmod +x pydigger
        ls -al
        tree

    - name: Collect data
      run: ./pydigger --download --report

    - name: Tree
      run: tree

#    - name: Commit new data
#      run: |
#        cd data
#        GIT_STATUS=$(git status --porcelain)
#        echo $GIT_STATUS
#        git config user.name github-actions[bot]
#        git config user.email 41898282+github-actions[bot]@users.noreply.github.com
#        git add .
#        if [ "$GIT_STATUS" != "" ]; then git commit -m "Automated data collection"; fi
#        if [ "$GIT_STATUS" != "" ]; then git push; fi
